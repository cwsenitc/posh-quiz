<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NITC Quiz Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center p-4">

    <div id="welcome-screen" class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border-t-8 border-indigo-600">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-black text-slate-800">Student Login</h1>
            <p class="text-slate-500">Enter details to begin</p>
        </div>
        <div class="space-y-4">
            <input type="text" id="userName" placeholder="Full Name" class="w-full p-4 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
            <input type="text" id="rollNo" placeholder="Roll Number" class="w-full p-4 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
            <div id="status-box" class="pt-4 text-center">
                <div id="wait-msg" class="p-4 bg-amber-50 border border-amber-200 rounded-xl text-amber-700 font-medium italic">
                    <span class="animate-pulse">‚è≥</span> Waiting for Admin to enable...
                </div>
                <button id="start-btn" onclick="startQuiz()" class="hidden w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg transition transform hover:scale-[1.02]">
                    Start Quiz (<span id="set-time-display">10</span> Mins)
                </button>
            </div>
        </div>
    </div>

    <div id="quiz-screen" class="hidden bg-white p-8 rounded-2xl shadow-xl w-full max-w-2xl">
        <div class="flex justify-between items-center mb-8 border-b pb-4">
            <span id="q-count" class="font-bold text-indigo-600 uppercase text-sm tracking-widest italic">Question 1</span>
            <div id="timer" class="text-2xl font-black text-red-600 font-mono">--:--</div>
        </div>
        <div class="mb-10 min-h-[150px]">
            <h2 id="q-text" class="text-2xl font-bold text-slate-800 mb-6 leading-tight"></h2>
            <div id="options-container" class="grid gap-3"></div>
        </div>
    </div>

    <div id="feedback-screen" class="hidden bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
        <h2 class="text-2xl font-bold mb-6">Quiz Finished!</h2>
        <div class="space-y-6 text-sm font-semibold">
            <div><label class="block mb-2">1. Difficulty Rate</label><select id="f1" class="w-full p-3 border rounded-xl"><option>Easy</option><option>Medium</option><option>Hard</option></select></div>
            <div><label class="block mb-2">2. Was time sufficient?</label><div class="flex gap-4"><label><input type="radio" name="f2" value="Yes" checked> Yes</label><label><input type="radio" name="f2" value="No"> No</label></div></div>
            <div><label class="block mb-2">3. Suggestions</label><textarea id="f3" class="w-full p-3 border rounded-xl" placeholder="Optional..."></textarea></div>
            <button onclick="submitFinal()" class="w-full bg-emerald-600 text-white font-bold py-4 rounded-xl shadow-md">Submit Final Responses</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAnG3Hk8AfZoG0fcI6QMwRLReUNcEFLcz8",
            authDomain: "cwseunnati.firebaseapp.com",
            projectId: "cwseunnati",
            storageBucket: "cwseunnati.firebasestorage.app",
            messagingSenderId: "557397468479",
            appId: "1:557397468479:web:55ff3a96b5c2b7f33c1f8a"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let questions = [], currentIndex = 0, timeLeft = 0, timerInterval, userAnswers = {};

        db.collection('settings').doc('quizStatus').onSnapshot(doc => {
            if(!doc.exists) return;
            const d = doc.data();
            const btn = document.getElementById('start-btn'), msg = document.getElementById('wait-msg');
            if(d.active) {
                btn.classList.remove('hidden'); msg.classList.add('hidden');
                document.getElementById('set-time-display').innerText = d.duration || 10;
                timeLeft = (d.duration || 10) * 60;
            } else {
                btn.classList.add('hidden'); msg.classList.remove('hidden');
            }
        });

        async function startQuiz() {
            const name = document.getElementById('userName').value, roll = document.getElementById('rollNo').value;
            if(!name || !roll) return alert("Fill details!");
            const qSnap = await db.collection('questions').get();
            questions = qSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            showQuestion(); startTimer();
        }

        function showQuestion() {
            const q = questions[currentIndex];
            document.getElementById('q-count').innerText = `Question ${currentIndex + 1} of ${questions.length}`;
            document.getElementById('q-text').innerText = q.text;
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            q.options.forEach(opt => {
                const b = document.createElement('button');
                b.className = "w-full text-left p-4 border-2 border-slate-100 rounded-xl hover:border-indigo-500 hover:bg-indigo-50 transition font-semibold";
                b.innerText = opt;
                b.onclick = () => { userAnswers[currentIndex] = { selected: opt, correct: q.correct, pts: q.points }; nextStep(); };
                container.appendChild(b);
            });
        }

        function nextStep() { currentIndex++; if(currentIndex < questions.length) showQuestion(); else endQuiz(); }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                const m = Math.floor(timeLeft/60), s = timeLeft%60;
                document.getElementById('timer').innerText = `${m}:${s<10?'0':''}${s}`;
                if(timeLeft <= 0) endQuiz();
            }, 1000);
        }

        function endQuiz() {
            clearInterval(timerInterval);
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('feedback-screen').classList.remove('hidden');
        }

        async function submitFinal() {
            let score = 0;
            Object.values(userAnswers).forEach(a => { if(a.selected === a.correct) score += parseInt(a.pts); });
            await db.collection('submissions').add({
                name: document.getElementById('userName').value, rollNo: document.getElementById('rollNo').value,
                score: score, feedback: { d: document.getElementById('f1').value, t: document.querySelector('input[name="f2"]:checked').value, s: document.getElementById('f3').value },
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("Results Submitted!"); location.reload();
        }
    </script>
</body>
</html>
