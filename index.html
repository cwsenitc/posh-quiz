<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoSH Quiz Portal | NITC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        .peer:checked + label { background-color: #4f46e5; color: white; border-color: #4f46e5; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center p-4">

    <div id="welcome-screen" class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border-t-8 border-indigo-600">
        <div class="text-center mb-8">
            <h1 class="text-2xl font-black text-slate-800 uppercase tracking-tight">PoSH Program Quiz</h1>
            <p class="text-slate-500 text-sm">CWSE & ICC, NITC</p>
        </div>
        <div class="space-y-4">
            <input type="text" id="userName" placeholder="Full Name" class="w-full p-4 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
            <input type="text" id="rollNo" placeholder="Roll Number" class="w-full p-4 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
            
            <div id="status-box" class="pt-4 text-center">
                <div id="wait-msg" class="p-4 bg-amber-50 border border-amber-200 rounded-xl text-amber-700 font-medium">
                    <span class="animate-pulse">‚è≥</span> Waiting for Admin to enable the quiz...
                </div>
                <button id="start-btn" onclick="startQuiz()" class="hidden w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg transition transform hover:scale-[1.02]">
                    Start Quiz (<span id="set-time-display">10</span> Mins)
                </button>
            </div>
        </div>
    </div>

    <div id="quiz-screen" class="hidden bg-white p-8 rounded-2xl shadow-xl w-full max-w-2xl">
        <div class="flex justify-between items-center mb-8 border-b pb-4">
            <span id="q-count" class="font-bold text-indigo-600 uppercase text-xs tracking-widest italic">Question 1</span>
            <div id="timer" class="text-2xl font-black text-red-600 font-mono">--:--</div>
        </div>
        <div class="mb-10 min-h-[150px]">
            <h2 id="q-text" class="text-xl font-bold text-slate-800 mb-6 leading-tight"></h2>
            <div id="options-container" class="grid gap-3"></div>
        </div>
    </div>

    <div id="feedback-screen" class="hidden bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
        <h2 class="text-2xl font-bold text-slate-900 mb-2">Program Feedback</h2>
        <p class="text-slate-500 mb-6 text-xs italic">Ratings are on a scale of 1 (Poor) to 5 (Excellent)</p>
        
        <div class="space-y-8">
            <div>
                <label class="block font-bold text-sm text-slate-700 mb-3">1. Was the program informative?</label>
                <div class="flex justify-between gap-2">
                    <template v-for="i in 5">
                        <input type="radio" name="f_inf" :id="'inf'+i" :value="i" class="hidden peer">
                        <label :for="'inf'+i" class="w-10 h-10 flex items-center justify-center border-2 rounded-lg cursor-pointer transition font-bold text-slate-400">i</label>
                    </template>
                    <input type="radio" name="f_inf" id="inf1" value="1" class="hidden peer"><label for="inf1" class="w-10 h-10 flex items-center justify-center border-2 rounded-lg cursor-pointer font-bold transition">1</label>
                    <input type="radio" name="f_inf" id="inf2" value="2" class="hidden peer"><label for="inf2" class="w-10 h-10 flex items-center justify-center border-2 rounded-lg cursor-pointer font-bold transition">2</label>
                    <input type="radio" name="f_inf" id="inf3" value="3" class="hidden peer"><label for="inf3" class="w-10 h-10 flex items-center justify-center border-2 rounded-lg cursor-pointer font-bold transition">3</label>
                    <input type="radio" name="f_inf" id="inf4" value="4" class="hidden peer"><label for="inf4" class="w-10 h-10 flex items-center justify-center border-2 rounded-lg cursor-pointer font-bold transition">4</label>
                    <input type="radio" name="f_inf" id="inf5" value="5" class="hidden peer" checked><label for="inf5" class="w-10 h-10 flex items-center justify-center border-2 rounded-lg cursor-pointer font-bold transition">5</label>
                </div>
            </div>

            <div>
                <label class="block font-bold text-sm text-slate-700 mb-3">2. Was the program well-organised?</label>
                <div class="flex justify-between gap-2">
                    <input type="radio" name="f_org" id="org1" value="1" class="hidden peer"><label for="org1" class="w-10 h-10 flex items-center justify-center border-2 rounded-lg cursor-pointer font-bold transition">1</label>
                    <input type="radio" name="f_org" id="org2" value="2" class="hidden peer"><label for="org2" class="w-10 h-10 flex items-center justify-center border-2 rounded-lg cursor-pointer font-bold transition">2</label>
                    <input type="radio" name="f_org" id="org3" value="3" class="hidden peer"><label for="org3" class="w-10 h-10 flex items-center justify-center border-2 rounded-lg cursor-pointer font-bold transition">3</label>
                    <input type="radio" name="f_org" id="org4" value="4" class="hidden peer"><label for="org4" class="w-10 h-10 flex items-center justify-center border-2 rounded-lg cursor-pointer font-bold transition">4</label>
                    <input type="radio" name="f_org" id="org5" value="5" class="hidden peer" checked><label for="org5" class="w-10 h-10 flex items-center justify-center border-2 rounded-lg cursor-pointer font-bold transition">5</label>
                </div>
            </div>

            <div>
                <label class="block font-bold text-sm text-slate-700 mb-3">3. Overall rating of the program</label>
                <div class="flex justify-between gap-2">
                    <input type="radio" name="f_rate" id="rt1" value="1" class="hidden peer"><label for="rt1" class="w-10 h-10 flex items-center justify-center border-2 rounded-lg cursor-pointer font-bold transition">1</label>
                    <input type="radio" name="f_rate" id="rt2" value="2" class="hidden peer"><label for="rt2" class="w-10 h-10 flex items-center justify-center border-2 rounded-lg cursor-pointer font-bold transition">2</label>
                    <input type="radio" name="f_rate" id="rt3" value="3" class="hidden peer"><label for="rt3" class="w-10 h-10 flex items-center justify-center border-2 rounded-lg cursor-pointer font-bold transition">3</label>
                    <input type="radio" name="f_rate" id="rt4" value="4" class="hidden peer"><label for="rt4" class="w-10 h-10 flex items-center justify-center border-2 rounded-lg cursor-pointer font-bold transition">4</label>
                    <input type="radio" name="f_rate" id="rt5" value="5" class="hidden peer" checked><label for="rt5" class="w-10 h-10 flex items-center justify-center border-2 rounded-lg cursor-pointer font-bold transition">5</label>
                </div>
            </div>

            <button onclick="submitFinal()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-xl shadow-lg transition">Submit Quiz & Feedback</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAnG3Hk8AfZoG0fcI6QMwRLReUNcEFLcz8",
            authDomain: "cwseunnati.firebaseapp.com",
            projectId: "cwseunnati",
            storageBucket: "cwseunnati.firebasestorage.app",
            messagingSenderId: "557397468479",
            appId: "1:557397468479:web:55ff3a96b5c2b7f33c1f8a"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let questions = [], currentIndex = 0, timeLeft = 0, timerInterval, userAnswers = {};

        // Sync Quiz Settings (Status and Time)
        db.collection('settings').doc('quizStatus').onSnapshot(doc => {
            if(!doc.exists) return;
            const d = doc.data();
            const btn = document.getElementById('start-btn'), msg = document.getElementById('wait-msg');
            if(d.active) {
                btn.classList.remove('hidden'); msg.classList.add('hidden');
                document.getElementById('set-time-display').innerText = d.duration || 10;
                timeLeft = (d.duration || 10) * 60;
            } else {
                btn.classList.add('hidden'); msg.classList.remove('hidden');
            }
        });

        async function startQuiz() {
            const name = document.getElementById('userName').value;
            const roll = document.getElementById('rollNo').value;
            if(!name || !roll) return alert("Please enter your name and roll number.");
        
            // 1. Fetch questions from Firestore
            const qSnap = await db.collection('questions').get();
            let fetchedQuestions = qSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));
            
            if(fetchedQuestions.length === 0) return alert("No questions available.");
        
            // 2. Shuffle the array (Fisher-Yates Algorithm)
            // This ensures they are randomized without being repeated
            for (let i = fetchedQuestions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [fetchedQuestions[i], fetchedQuestions[j]] = [fetchedQuestions[j], fetchedQuestions[i]];
            }
        
            // 3. Set the global questions variable to the shuffled list
            questions = fetchedQuestions;
        
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            showQuestion(); 
            startTimer();
        }

        function showQuestion() {
            const q = questions[currentIndex];
            document.getElementById('q-count').innerText = `Question ${currentIndex + 1} of ${questions.length}`;
            document.getElementById('q-text').innerText = q.text;
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            q.options.forEach(opt => {
                const b = document.createElement('button');
                b.className = "w-full text-left p-4 border-2 border-slate-100 rounded-xl hover:border-indigo-500 hover:bg-indigo-50 transition font-semibold text-slate-700";
                b.innerText = opt;
                b.onclick = () => { userAnswers[currentIndex] = { selected: opt, correct: q.correct, pts: q.points }; nextStep(); };
                container.appendChild(b);
            });
        }

        function nextStep() { currentIndex++; if(currentIndex < questions.length) showQuestion(); else endQuiz(); }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                const m = Math.floor(timeLeft/60), s = timeLeft%60;
                document.getElementById('timer').innerText = `${m}:${s<10?'0':''}${s}`;
                if(timeLeft <= 0) endQuiz();
            }, 1000);
        }

        function endQuiz() {
            clearInterval(timerInterval);
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('feedback-screen').classList.remove('hidden');
        }

        async function submitFinal() {
            let score = 0;
            Object.values(userAnswers).forEach(a => { if(a.selected === a.correct) score += parseInt(a.pts); });
            
            const feedback = {
                inf: document.querySelector('input[name="f_inf"]:checked').value,
                org: document.querySelector('input[name="f_org"]:checked').value,
                rate: document.querySelector('input[name="f_rate"]:checked').value
            };

            await db.collection('submissions').add({
                name: document.getElementById('userName').value,
                rollNo: document.getElementById('rollNo').value,
                score: score,
                feedback: feedback,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("Quiz and Feedback submitted successfully!");
            location.reload();
        }
    </script>
</body>
</html>
